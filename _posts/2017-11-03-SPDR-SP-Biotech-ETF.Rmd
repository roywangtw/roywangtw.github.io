---
title: "Time Series Analysis of SPDR S&P Biotech ETF (XBI)"
author: "Roy Wang"
date: "Nov 3, 2017"
output:
  html_notebook: default
  pdf_document: default
---

### 1. Introduction

This post presents a simple time series analysis of [SPDR S&P Biotech ETF (XBI)](https://us.spdrs.com/en/etf/spdr-sp-biotech-etf-XBI) using autoregressive integrated moving average (ARIMA) models to forecast future price movements.

The ETF tracks a modified equal weighted index comprised of biotech stocks listed on major U.S. stock exchanges. A summary prospectus can be found [here](https://us.spdrs.com/public/XBI_SUMPRO.pdf).

***

### 2. Data Retrieval and Exploration

Due to the limitations on data retrieval from Yahoo! Finance, our data dates back to only `r format(time(ts[1, ]), format = "%B %d, %Y")`, which is forturnately merely less than a year after the ETF's inception date.

```{r, message=FALSE}
library(quantmod) #Load the quantmod package
ts <- Cl(getSymbols("XBI", src = "yahoo", auto.assign = FALSE)) #Retrieve and extract the ETF's closing price data from Yahoo! Finance
sum(is.na(ts)) #Check for missing data
head(ts) #View the first few rows
tail(ts) #View the last few rows
dim(ts) #Check the numbers of rows and columns
frequency(ts) #Check the number of observations per unit time
```

In sum, our data contains `r dim(ts)[1]` observations and `r dim(ts)[2]` column, with `r frequency(ts)` day for each unit time, spanning from `r format(time(ts[1, ]), format = "%B %d, %Y")` to `r format(time(ts[nrow(ts), ]), format = "%B %d, %Y")`.

The ETF's past performance is shown below. 

```{r, message=FALSE}
library(ggplot2) #Load the ggplot2 package for plotting
library(scales) #Load the scales package to format the Y axis labels
ggplot(ts, aes(time(ts), XBI.Close)) +  #Visualize the time series with a timeplot
  geom_line(color = "darkblue") +
  ggtitle("SPDR S&P Biotech ETF - Closing Prices") +
  ylim(10, 100) +
  xlab("") +
  ylab("Closing Prices") +
  scale_y_continuous(labels = dollar)
```

The ETF had a strong impressive bull run from early 2011 through mid July in 2015, but then suffered a huge downturn that saw its net asset value halved before climbing back again to recent highs as of early November, 2017.

***

### 3. Time Series Analysis

It is clear from the timeplot above the closing prices' time series is anything but stationary, as it wanders up and down over for sustained periods. A formal Augmented Dickey-Fuller (ADF) test below also does not reject the null hypothesis of non-stationarity. 

```{r}
library(tseries) #Load the tseries package for Augmented Dickey-Fuller Test
adf.test(ts, alternative = "stationary") #Run the ADF test to verify stationarity
```

Therefore, we need to take the first difference of the time series, which involves subtracting the previous entry's value from the value of the current period.    

```{r}
ts.diff <- diff(ts)[-1, ] #Take the first difference on the time series and remove the first row which contains NA
head(ts.diff) #Check the first few rows
ts.plot(ts.diff) #Plot the new differenced series
adf.test(ts.diff, alternative = "stationary") #Run the ADF test to verify stationarity
```

The plot of our new differenced series shows an oscillating pattern around zero with no visible clear trend. More importantly, the ADF test result  rejects the null hypotheses of non-stationarity, suggesting the series most likely conforms to stationarity and thus differencing of order 1 is sufficient.

Regarding the order parameters for ARIMA modeling, the autocorrelation function (ACF) plot below indicates white noise with almost no significant autocorrelation, whereas the partial autocorrelation function (PACF) plot points out significant autocorrelations at lag 4, 13, and beyond. In this case, we might want to try models with AR components of order 4, 13, or even bigger ones. 

```{r}
par(mar = c(4, 4, 4, 4)) #Adjust for the right graphic margins
acf(ts.diff, main = "ACF for Differenced Series") #Check for MA lags
pacf(ts.diff, main = "PACF for Differenced Series") #Check for AR lags
```

Then we apply the original time series of the ETF's closing prices to **auto.arima** function.

```{r}
library(forecast) #Load the forecast package for fitting the series data to the ARIMA model
ts.arima <- auto.arima(ts) #Fit the ARIMA model
print(ts.arima) #Print out the model results
```

The result recommends ARIMA(3,1,2) model with drift whose 6 coefficients are all statistically significant at the 95% confidence level. 

However, before we make some forecasts, we need to examine the ACF and PACF plots for model residuals to see if this ARIMA(3,1,2) model is trustworthy enough.

```{r}
tsdisplay(residuals(ts.arima)) #Plot the model residuals
Box.test(residuals(ts.arima), type = "Ljung-Box", lag = 20) #Run Ljung-Box test with lag = 20 to capture any significant and troublesome correlations
```

The Ljung-Box test returns a signifciant Q(20) for model residuals, which suggests there is probably some issue with this model.

Futuremore, both the model residuals plots above and the previously mentioned PACF plot for the differenced series highlight a clear pattern at lag 13. This suggests our ARIMA model can probably be further improved with a specification of *p = 13* or *q = 13*.

```{r}
ts.arima.ar13 <- Arima(ts, order = c(13,1,2)) 
print(ts.arima.ar13)
tsdisplay(residuals(ts.arima.ar13))
Box.test(residuals(ts.arima.ar13), type = "Ljung-Box", lag = 20)
ts.arima.ma13 <- Arima(ts, order = c(3,1,13))
print(ts.arima.ma13)
tsdisplay(residuals(ts.arima.ma13))
Box.test(residuals(ts.arima.ma13), type = "Ljung-Box", lag = 20)
```

Both the ARIMA(13,1,2) and ARIMA(3,1,13) models improve upon the previous ARIMA(3,1,2) model in that

1. the AIC for the revised models are both smaller than that of the ARIMA(3,1,2) model;

2. the diagnostic plots this time look more like white noise with no significant autocorrelations present;

3. Ljung-Box test results for both models suggest non-significant model residuals. 

In this case, we will go with the *ARIMA(13,1,2)* model, which has a slightly smaller AIC, for prediction.

***

### 4. Predictions

Our model's predictions for the next 30 trading days are presented below.

```{r}
library(astsa)
ts.prediction <- sarima.for(ts, n.ahead = 30, 13, 1, 2)
print(ts.prediction)
```

Are these predictions reliable?

We designate the past 30 trading days in our time series as the "hold out" set, fit our chosen ARIMA model, and see how well the predictions fit the actual observed values.

```{r}
ts.trun <- window(ts, end = time(tail(ts, n = 31)[1]))
sarima.for(ts.trun, n.ahead = 30, 13, 1, 2)
lines.default(ts)
```

The red circles represent the predicted values for the past 30 trading days, forming a nearly straight line very quickly, which is odd given the series' predominantly oscillating pattern. 

Nonetheless, most of the actual observed values (i.e. the black line) do fall within the bounds of the 80% and 95% confidence levels (i.e. the grey shaded areas), hence lending our current model some degree of credibility. 

***

### 5. Summary

This post presents a simple demonstration of using ARIMA modeling for predicting security price movements, and our model, at its current form, remains fairly naive. 

More refinements on the model may come from segmenting out bull run periods from bear run periods for more sophisticated analysis, but that would be left for future exploration.